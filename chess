<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>משחק שחמט - 2 שחקנים ובוט</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- css של הלוח -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #202020;
    color: #eee;
    text-align: center;
    padding: 20px;
    user-select: none;
  }
  #board {
    width: 400px;
    margin: 20px auto;
  }
  #status {
    margin: 10px;
    font-size: 18px;
  }
  #controls {
    margin: 20px auto;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  button {
    padding: 10px 15px;
    font-size: 16px;
    background-color: #444;
    color: #eee;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #777;
    cursor: not-allowed;
  }
  select {
    font-size: 16px;
    padding: 6px;
  }
</style>
</head>
<body>
<h1>משחק שחמט - 2 שחקנים או מול בוט</h1>
<div id="board"></div>
<div id="status"></div>
<div id="controls">
  <button id="btnPvP">שחק 2 שחקנים</button>
  <button id="btnPvBot">שחק מול בוט</button>
  <select id="botLevel" title="רמת הבוט">
    <option value="random">רנדומלי (קל)</option>
    <option value="easy">קל - חיפוש עומק 1</option>
    <option value="medium" selected>בינוני - חיפוש עומק 2</option>
  </select>
  <button id="btnRestart">התחל מחדש</button>
</div>

<!-- ספריית chess.js -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<!-- ספריית chessboard.js -->
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>

<script>
  const boardElement = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const btnPvP = document.getElementById('btnPvP');
  const btnPvBot = document.getElementById('btnPvBot');
  const btnRestart = document.getElementById('btnRestart');
  const botLevelSelect = document.getElementById('botLevel');

  let board = null;
  let game = new Chess();

  let gameMode = 'pvp'; // pvp או pvbot
  let botLevel = botLevelSelect.value;
  let playerColor = 'w'; // הצבע של השחקן מול בוט (לבן תמיד)
  let isGameOver = false;

  // הפעלת הלוח
  function onDragStart(source, piece, position, orientation) {
    if (isGameOver) return false;

    // לא לאפשר להזיז את כלים של היריב
    if (game.turn() !== playerColor && gameMode === 'pvbot') {
      return false;
    }

    // 2 שחקנים - לא ניתן להזיז כלים של היריב
    if (gameMode === 'pvp' && piece[0] !== game.turn()) {
      return false;
    }
  }

  function onDrop(source, target) {
    if (isGameOver) return 'snapback';

    const move = game.move({
      from: source,
      to: target,
      promotion: 'q' // קידום אוטומטי למלכה
    });

    // מהלך לא חוקי
    if (move === null) return 'snapback';

    updateStatus();

    if (gameMode === 'pvbot' && !isGameOver) {
      window.setTimeout(makeBotMove, 250);
    }
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  function updateStatus() {
    let status = '';

    let moveColor = game.turn() === 'w' ? 'לבן' : 'שחור';

    if (game.in_checkmate()) {
      status = 'שחמט - ' + (moveColor === 'לבן' ? 'שחור' : 'לבן') + ' ניצח!';
      isGameOver = true;
    } else if (game.in_draw()) {
      status = 'תיקו!';
      isGameOver = true;
    } else if (game.in_check()) {
      status = moveColor + ' בשח - תיזהר!';
    } else {
      status = 'תור ל-' + moveColor;
    }

    statusEl.innerText = status;
  }

  // הפעלת הלוח
  function initBoard() {
    if(board) board.destroy();

    board = Chessboard(boardElement, {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd,
      pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });
  }

  // בוט רנדומלי - מחפש מהלכים חוקיים ומבצע אחד מהם
  function makeBotMove() {
    if (isGameOver) return;
    if (game.turn() !== 'b') return; // הבוט משחק בשחור

    let moves = game.moves();
    if (moves.length === 0) return;

    let move = null;

    if (botLevel === 'random') {
      move = moves[Math.floor(Math.random() * moves.length)];
    } else {
      // חיפוש מינימקס עומק 1 או 2
      const depth = botLevel === 'easy' ? 1 : 2;
      move = minimaxRoot(depth, game, true);
    }

    game.move(move);
    board.position(game.fen());
    updateStatus();
  }

  // פונקציות מינימקס (פשוטות) להערכת הלוח

  const pieceValues = {
    p: 10,
    n: 30,
    b: 30,
    r: 50,
    q: 90,
    k: 900
  };

  function evaluateBoard(game) {
    const board = game.board();
    let totalEvaluation = 0;
    for (let row of board) {
      for (let piece of row) {
        if (piece !== null) {
          const value = pieceValues[piece.type];
          totalEvaluation += piece.color === 'w' ? value : -value;
        }
      }
    }
    return totalEvaluation;
  }

  function minimax(depth, game, isMaximizingPlayer) {
    if (depth === 0 || game.game_over()) {
      return evaluateBoard(game);
    }

    const moves = game.moves();

    if (isMaximizingPlayer) {
      let maxEval = -Infinity;
      for (let i = 0; i < moves.length; i++) {
        game.move(moves[i]);
        const evalScore = minimax(depth -1, game, false);
        game.undo();
        maxEval = Math.max(maxEval, evalScore);
      }
      return maxEval;
    } else {
      let minEval = Infinity;
      for (let i = 0; i < moves.length; i++) {
        game.move(moves[i]);
        const evalScore = minimax(depth -1, game, true);
        game.undo();
        minEval = Math.min(minEval, evalScore);
      }
      return minEval;
    }
  }

  function minimaxRoot(depth, game, isMaximizingPlayer) {
    const moves = game.moves();
    let bestMove = null;
    let bestValue = -Infinity;

    for (let i = 0; i < moves.length; i++) {
      game.move(moves[i]);
      let boardValue = minimax(depth -1, game, !isMaximizingPlayer);
      game.undo();
      if (boardValue > bestValue) {
        bestValue = boardValue;
        bestMove = moves[i];
      }
    }

    return bestMove;
  }

  // כפתורים
  btnPvP.addEventListener('click', () => {
    gameMode = 'pvp';
    startGame();
  });

  btnPvBot.addEventListener('click', () => {
    gameMode = 'pvbot';
    botLevel = botLevelSelect.value;
    startGame();
  });

  btnRestart.addEventListener('click', () => {
    startGame();
  });

  botLevelSelect.addEventListener('change', () => {
    botLevel = botLevelSelect.value;
  });

  // התחלת משחק חדש
  function startGame() {
    game.reset();
    isGameOver = false;
    updateStatus();
    board.position(game.fen());
    if(gameMode === 'pvbot' && game.turn() !== playerColor){
      // אם תור הבוט בתחילת המשחק (שחור)
      makeBotMove();
    }
  }

  // אתחול
  initBoard();
  startGame();
</script>

</body>
</html>
