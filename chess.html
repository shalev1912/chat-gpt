<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>משחק שחמט - שחק נגד שחקן או בוט</title>

<!-- ספריית chessboard.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>

<!-- ספריית chess.js -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>

<style>
  body {
    font-family: 'Heebo', sans-serif;
    background: #222;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    margin: 0;
    padding: 20px;
  }
  h1 {
    margin-bottom: 12px;
  }
  #board {
    margin-top: 20px;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
  }
  select, button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    cursor: pointer;
  }
  select {
    min-width: 160px;
  }
  button {
    background: #4caf50;
    color: white;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #45a049;
  }
  #status {
    margin-top: 15px;
    font-size: 18px;
  }
  #backHome {
    margin-top: auto;
    margin-bottom: 10px;
    background: #555;
    color: #eee;
    border-radius: 8px;
    padding: 8px 14px;
    text-decoration: none;
  }
  #backHome:hover {
    background: #666;
  }
  /* רספונסיביות */
  @media(max-width:600px){
    #board {
      width: 90vw !important;
      height: 90vw !important;
    }
  }
</style>

</head>
<body>

<h1>משחק שחמט</h1>

<div class="controls">
  <label for="modeSelect">בחר מצב משחק:</label>
  <select id="modeSelect" aria-label="בחר מצב משחק">
    <option value="human">שחק נגד שחקן</option>
    <option value="bot">שחק נגד בוט</option>
  </select>

  <label for="difficultySelect" id="diffLabel" style="display:none;">בחר רמת קושי:</label>
  <select id="difficultySelect" style="display:none;" aria-label="בחר רמת קושי">
    <option value="easy">קל</option>
    <option value="medium">בינוני</option>
    <option value="hard">קשה</option>
  </select>

  <button id="restartBtn" aria-label="התחל משחק מחדש">התחל משחק חדש</button>
</div>

<div id="board" style="width: 480px"></div>

<div id="status" role="status" aria-live="polite"></div>

<a href="https://shalev1912.github.io/chat-gpt/home.html" id="backHome" role="link" aria-label="חזרה למסך הבית">← חזרה למסך הבית</a>

<script>
  const boardElement = document.getElementById('board');
  const modeSelect = document.getElementById('modeSelect');
  const difficultySelect = document.getElementById('difficultySelect');
  const diffLabel = document.getElementById('diffLabel');
  const restartBtn = document.getElementById('restartBtn');
  const statusEl = document.getElementById('status');

  let board = null;
  let game = new Chess();

  let currentMode = 'human'; // human or bot
  let botDifficulty = 'easy'; // easy, medium, hard
  let isPlayerTurn = true; // אם תור שחקן

  // עדכון מצב המשחק בטקסט
  function updateStatus() {
    let status = '';
    if (game.in_checkmate()) {
      status = 'מט! המשחק נגמר.';
    } else if (game.in_draw()) {
      status = 'תיקו!';
    } else {
      let turn = game.turn() === 'w' ? 'לבן' : 'שחור';
      status = `תור ${turn}`;
      if (game.in_check()) {
        status += ' - שח למלך!';
      }
    }
    statusEl.textContent = status;
  }

  // הפעלת הלוח
  function onDragStart(source, piece, position, orientation) {
    if (game.game_over()) return false;

    if (currentMode === 'bot') {
      // אם בוט משחק שחור, השחקן שחקן לבן בלבד
      if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
      }
    }
    // בחירת חתיכה רק בתור השחקן
    if (game.turn() === 'w' && piece.search(/^b/) !== -1) return false;
    if (game.turn() === 'b' && piece.search(/^w/) !== -1) return false;

    return true;
  }

  // שינוי מיקום חתיכה
  function onDrop(source, target) {
    // נסיון לבצע מהלך
    let move = game.move({
      from: source,
      to: target,
      promotion: 'q' // פרומושן אוטומטי למלכה
    });

    if (move === null) return 'snapback'; // מהלך לא חוקי

    updateStatus();

    if (currentMode === 'bot' && !game.game_over()) {
      // תור הבוט אחרי שהשחקן שיחק
      window.setTimeout(makeBotMove, 600);
    }
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  // בוט - בחירת מהלך לפי רמת קושי
  function makeBotMove() {
    if (game.game_over()) return;

    let possibleMoves = game.moves();

    if (possibleMoves.length === 0) return;

    let move = null;

    if (botDifficulty === 'easy') {
      // בחירת מהלך אקראי
      const randomIndex = Math.floor(Math.random() * possibleMoves.length);
      move = possibleMoves[randomIndex];
    } else if (botDifficulty === 'medium') {
      // בוחרים מהלך שמונע שחתיכה תהיה באיום (פשוט) או אקראי
      // פשוט כאן - בוחרים מהלך אקראי מתוך ה- top 3 מהלכים (לפי סדר)
      const top3 = possibleMoves.slice(0, 3);
      const randomIndex = Math.floor(Math.random() * top3.length);
      move = top3[randomIndex];
    } else if (botDifficulty === 'hard') {
      // רמה קשה - לבחור מהלך שמונע התקפות - נעזר בלוגיקה בסיסית:
      // לדוגמה, נמנע מהלכים שמכניסים את המלך לבדיקה.
      // לאחר מכן בוחר את המהלך שמקדם את התוצאה - לפי הערכה פשוטה.
      // כאן, נעשה הערכה בסיסית לפי captured value (לא מושלם)
      // נשתמש בchess.js לבדוק מהלך חוקי ונבדוק הערכה פשוטה:

      let bestMove = null;
      let bestScore = -Infinity;

      for (let m of possibleMoves) {
        game.move(m);
        let score = evaluateBoard(game);
        game.undo();
        if (score > bestScore) {
          bestScore = score;
          bestMove = m;
        }
      }
      move = bestMove;
    }

    game.move(move);
    board.position(game.fen());
    updateStatus();
  }

  // פונקציית הערכת לוח פשוטה - הבדיקה מחושבת לזווית הבוט
  // נחשב לפי הערכת חומר פשוטה - מביא +10 לכל מלכה, +5 לרץ וכו'
  function evaluateBoard(gameInstance) {
    const values = {
      p: 1,
      n: 3,
      b: 3,
      r: 5,
      q: 9,
      k: 0
    };
    let score = 0;
    let fen = gameInstance.fen();
    for (let char of fen) {
      if (char === ' ') break;
      let lower = char.toLowerCase();
      if (values[lower]) {
        let val = values[lower];
        if (char === lower) score -= val; // שחורות
        else score += val; // לבנות
      }
    }
    return score;
  }

  // אתחול לוח
  function init() {
    board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd,
      pieceTheme: 'https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/img/chesspieces/wikipedia/{piece}.png'
    });

    updateStatus();
  }

  // עדכון מצב בחירה בין שחקן/בוט ורמת קושי
  modeSelect.addEventListener('change', () => {
    currentMode = modeSelect.value;
    if (currentMode === 'bot') {
      difficultySelect.style.display = 'inline-block';
      diffLabel.style.display = 'inline-block';
    } else {
      difficultySelect.style.display = 'none';
      diffLabel.style.display = 'none';
    }
    resetGame();
  });

  difficultySelect.addEventListener('change', () => {
    botDifficulty = difficultySelect.value;
  });

  restartBtn.addEventListener('click', () => {
    resetGame();
  });

  // איפוס משחק
  function resetGame() {
    game.reset();
    board.position('start');
    updateStatus();
  }

  window.onload = () => {
    init();
  }
</script>

</body>
</html>