<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>משחק שחמט - 2 שחקנים ובוט</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<style>
  @keyframes bgGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(-45deg, #1e3c72, #2a5298, #4b6cb7, #182848);
    background-size: 400% 400%; animation: bgGradient 20s ease infinite;
    color: #d0d6f9; text-align: center; padding: 25px; user-select: none;
  }
  h1 { font-weight: 700; font-size: 2.2rem; margin-bottom: 12px; text-shadow: 0 0 6px #6a63ffaa; }
  #board { width: 400px; margin: 20px auto; border-radius: 14px; box-shadow: 0 8px 24px rgba(106,99,255,0.3); }
  .chessboard { border-radius: 14px !important; box-shadow: 0 10px 20px rgba(106,99,255,0.3); }
  #status { margin: 18px auto; font-size: 20px; font-weight: 600; color: #a3b1ff; text-shadow: 0 0 4px #8e8dff88; animation: pulse 2.5s infinite; }
  @keyframes pulse { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
  #controls { margin: 25px auto 0; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }
  button { padding:12px 18px; font-size:17px; font-weight:600; background-color:#4b6cb7; color:#eef1ff; border:none; border-radius:12px; cursor:pointer; user-select:none; box-shadow:0 3px 8px rgba(75,108,183,0.4); transition:background-color .3s, box-shadow .3s, transform .15s; }
  button:hover:not(:disabled){ background-color:#5f7fd6; transform:translateY(-2px); }
  button.active{ background-color:#6a7fd6; box-shadow:0 0 10px #a3aaffaa; }
  button:disabled{ background-color:#72768d; cursor:not-allowed; color:#b0b3c6; box-shadow:none; }
  select { font-size:16px; padding:8px 12px; border-radius:10px; border:2px solid #5f72be; background-color:#394b82; color:#dbe1ff; font-weight:600; box-shadow:0 3px 10px rgba(95,114,190,0.5); }
  select:disabled { background-color:#3b4262; border-color:#666d8a; color:#8b8fbd; }
  @media (max-width:420px){ #board{width:320px;} }
</style>
</head>
<body>
<h1>משחק שחמט - 2 שחקנים או מול בוט</h1>
<div id="board"></div>
<div id="status"></div>
<div id="controls">
  <button id="btnPvP" type="button">שחק 2 שחקנים</button>
  <button id="btnPvBot" type="button">שחק מול בוט</button>
  <select id="botLevel" title="רמת הבוט" disabled>
    <option value="random">רנדומלי (קל)</option>
    <option value="easy">קל - חיפוש עומק 1</option>
    <option value="medium" selected>בינוני - חיפוש עומק 2</option>
  </select>
  <button id="btnRestart" type="button">התחל מחדש</button>
  <button id="btnHome" type="button">מסך בית</button>
</div>

<!-- ספריות -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>

<script>
  // אלמנטים
  const statusEl = document.getElementById('status');
  const btnPvP = document.getElementById('btnPvP');
  const btnPvBot = document.getElementById('btnPvBot');
  const btnRestart = document.getElementById('btnRestart');
  const btnHome = document.getElementById('btnHome');
  const botLevelSelect = document.getElementById('botLevel');

  // מצב משחק
  let board = null;
  let game = new Chess();
  let gameMode = 'pvp'; // 'pvp' או 'pvbot'
  let botLevel = botLevelSelect.value;
  const playerColor = 'w'; // כששחקן משחק מול הבוט - השחקן ישחק לבן, הבוט שחור
  let isGameOver = false;

  // ערכים לחישוב מינימקס
  const pieceValues = { p:10, n:30, b:30, r:50, q:90, k:900 };

  function updateControlsUI(){
    if(gameMode === 'pvp'){
      btnPvP.classList.add('active');
      btnPvBot.classList.remove('active');
      botLevelSelect.disabled = true;
    } else {
      btnPvP.classList.remove('active');
      btnPvBot.classList.add('active');
      botLevelSelect.disabled = false;
    }
  }

  function updateStatus(){
    let status = '';
    const moveColor = game.turn() === 'w' ? 'לבן' : 'שחור';
    if (game.in_checkmate()) {
      status = 'שחמט - ' + (moveColor === 'לבן' ? 'שחור' : 'לבן') + ' ניצח!';
      isGameOver = true;
    } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material) {
      status = 'תיקו!';
      isGameOver = true;
    } else if (game.in_check()) {
      status = moveColor + ' בשח - תיזהר!';
    } else {
      status = 'תור ל-' + moveColor;
    }
    statusEl.innerText = status;
  }

  // אירועים ללוח
  function onDragStart(source, piece, position, orientation) {
    if (isGameOver) return false;
    // אם אין כלי שניסו לגרור
    if (!piece) return false;

    // במצב PvBot — לא לאפשר להזיז כשזה לא תור השחקן (השחקן לבן)
    if (gameMode === 'pvbot') {
      // רק אם תור השחור (הבוט) — חסום
      if (game.turn() !== playerColor) return false;
    }

    // במצב PvP — לא לאפשר להזיז כלים שלא שייכים לשחקן שמסומן בתור
    if (gameMode === 'pvp') {
      if (piece[0] !== game.turn()) return false;
    }
  }

  function onDrop(source, target) {
    if (isGameOver) return 'snapback';
    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';
    board.position(game.fen());
    updateStatus();

    // אם מול בוט — לתת לבוט לזוז (אם לא סיום)
    if (gameMode === 'pvbot' && !isGameOver) {
      setTimeout(makeBotMove, 220);
    }
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  // אתחול הלוח — שימו לב: chessboardjs ציפתה לקבל מזהה אלמנט כ-string
  function initBoard() {
    try {
      if (board) board.destroy();
      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
      });
    } catch (e) {
      console.error('שגיאה באתחול הלוח:', e);
      alert('שגיאה באתחול לוח השח מט — בדוק חיבור לאינטרנט לספריות או את קונסול הדפדפן.');
    }
  }

  // פונקציות הערכת לוח ומינימקס
  function evaluateBoard(gameInstance) {
    const b = gameInstance.board();
    let total = 0;
    for (let row of b) {
      for (let p of row) {
        if (p !== null) {
          total += (p.color === 'w' ? 1 : -1) * (pieceValues[p.type] || 0);
        }
      }
    }
    return total;
  }

  function minimax(depth, gameInstance, isMaximizingPlayer) {
    if (depth === 0 || gameInstance.game_over()) {
      return evaluateBoard(gameInstance);
    }
    const moves = gameInstance.moves();
    if (isMaximizingPlayer) {
      let maxEval = -Infinity;
      for (let i = 0; i < moves.length; i++) {
        gameInstance.move(moves[i]);
        const evalScore = minimax(depth - 1, gameInstance, false);
        gameInstance.undo();
        if (evalScore > maxEval) maxEval = evalScore;
      }
      return maxEval;
    } else {
      let minEval = Infinity;
      for (let i = 0; i < moves.length; i++) {
        gameInstance.move(moves[i]);
        const evalScore = minimax(depth - 1, gameInstance, true);
        gameInstance.undo();
        if (evalScore < minEval) minEval = evalScore;
      }
      return minEval;
    }
  }

  function minimaxRoot(depth, gameInstance, isMaximizingPlayer) {
    const moves = gameInstance.moves();
    let bestMove = moves[0];
    let bestValue = -Infinity;
    for (let i = 0; i < moves.length; i++) {
      gameInstance.move(moves[i]);
      const val = minimax(depth - 1, gameInstance, !isMaximizingPlayer);
      gameInstance.undo();
      if (val > bestValue) { bestValue = val; bestMove = moves[i]; }
    }
    return bestMove;
  }

  // מהלך הבוט
  function makeBotMove() {
    if (isGameOver) return;
    if (game.turn() !== 'b') return; // הבוט משחק בשחור
    const moves = game.moves();
    if (moves.length === 0) return;

    let chosen = null;
    if (botLevel === 'random') {
      chosen = moves[Math.floor(Math.random() * moves.length)];
    } else {
      const depth = botLevel === 'easy' ? 1 : 2;
      chosen = minimaxRoot(depth, game, true);
    }

    game.move(chosen);
    board.position(game.fen());
    updateStatus();
  }

  // אירועי כפתורים
  btnPvP.addEventListener('click', () => {
    gameMode = 'pvp';
    updateControlsUI();
    startGame();
  });

  btnPvBot.addEventListener('click', () => {
    gameMode = 'pvbot';
    botLevel = botLevelSelect.value;
    updateControlsUI();
    startGame();
  });

  btnRestart.addEventListener('click', () => startGame());

  botLevelSelect.addEventListener('change', (e) => {
    botLevel = e.target.value;
  });

  btnHome.addEventListener('click', () => {
    // שנה כאן לכתובת הבית שלך
    window.location.href = 'https://shalev1912.github.io/chat-gpt/home.html';
  });

  // התחלת משחק חדש
  function startGame() {
    game = new Chess();
    isGameOver = false;
    updateStatus();
    board.start(); // מחזיר את הלוח למצב התחלתי
    board.position(game.fen());
    // אם בחרת במצב pvbot והבוט צריך להתחיל — אפשר לגרום לו לזוז
    if (gameMode === 'pvbot' && game.turn() !== playerColor) {
      setTimeout(makeBotMove, 200);
    }
  }

  // אתחול כשטעינה הסתיימה
  window.addEventListener('load', () => {
    initBoard();
    updateControlsUI();
    startGame();
  });
</script>
</body>
</html>