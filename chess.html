<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>משחק שחמט מקצועי נגד Stockfish</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Heebo', sans-serif;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
  }
  h1 {
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 2rem;
  }
  .controls {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  select, button {
    font-size: 1rem;
    padding: 10px 15px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    color: #333;
  }
  select {
    min-width: 140px;
  }
  button {
    background: #6a5acd;
    color: white;
    transition: background-color 0.3s;
  }
  button:hover {
    background: #5548b6;
  }
  #difficultySelect {
    display: none;
  }
  #board {
    width: 480px;
    max-width: 90vw;
    margin-bottom: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  #status {
    font-weight: 700;
    min-height: 32px;
    font-size: 1.2rem;
    text-align: center;
    margin-bottom: 15px;
  }
  @media (max-width: 520px) {
    #board {
      width: 95vw;
    }
  }
  a#backHome {
    margin-top: auto;
    color: #eee;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
  }
  a#backHome:hover {
    color: #b8b8ff;
  }
</style>

<!-- ספריות chessboardjs ו chess.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>

</head>
<body>

<h1>משחק שחמט מקצועי</h1>

<div class="controls" role="region" aria-label="בחירת מצב ורמת קושי">
  <select id="modeSelect" aria-label="בחר מצב משחק">
    <option value="human">שחק נגד שחקן</option>
    <option value="stockfish">שחק נגד Stockfish</option>
  </select>

  <select id="difficultySelect" aria-label="בחר רמת קושי">
    <option value="4">קל (4)</option>
    <option value="8" selected>בינוני (8)</option>
    <option value="12">קשה (12)</option>
  </select>

  <button id="restartBtn" aria-label="התחל משחק חדש">התחל משחק חדש</button>
  <button id="undoBtn" aria-label="בטל מהלך">בטל מהלך</button>
  <button id="resignBtn" aria-label="ויתר">וויתר</button>
</div>

<div id="board"></div>
<div id="status" role="status" aria-live="polite">טוען...</div>

<a id="backHome" href="https://shalev1912.github.io/chat-gpt/home.html" role="link">← חזרה למסך הבית</a>

<script>
  let board = null;
  let game = new Chess();
  let engine = null;
  let engineReady = false;
  let playerColor = 'w';
  let waitingForEngineMove = false;

  const modeSelect = document.getElementById('modeSelect');
  const difficultySelect = document.getElementById('difficultySelect');
  const restartBtn = document.getElementById('restartBtn');
  const undoBtn = document.getElementById('undoBtn');
  const resignBtn = document.getElementById('resignBtn');
  const statusEl = document.getElementById('status');

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function updateStatus() {
    if (game.in_checkmate()) {
      setStatus('מט! המשחק נגמר.');
    } else if (game.in_draw()) {
      setStatus('תיקו!');
    } else {
      const turn = game.turn() === 'w' ? 'לבן' : 'שחור';
      if (game.in_check()) {
        setStatus(`תור ${turn} - שח למלך!`);
      } else {
        setStatus(`תור ${turn}`);
      }
    }
  }

  function createEngine() {
    try {
      engine = new Worker('stockfish.js');
      engine.onmessage = function(event) {
        const line = event.data;
        // console.log('engine:', line);

        if (line === 'uciok') {
          engineReady = true;
          engine.postMessage('isready');
        } else if (line === 'readyok') {
          setStatus('Stockfish מוכן');
          if (waitingForEngineMove) {
            requestEngineMove();
          }
        } else if (line.startsWith('bestmove')) {
          waitingForEngineMove = false;
          const move = line.split(' ')[1];
          game.move({from: move.substring(0,2), to: move.substring(2,4), promotion:'q'});
          board.position(game.fen());
          updateStatus();
        }
      };
      engine.postMessage('uci');
    } catch(e) {
      setStatus('אין אפשרות להפעיל Stockfish');
    }
  }

  function requestEngineMove() {
    if (!engineReady) {
      waitingForEngineMove = true;
      return;
    }
    const fen = game.fen();
    const depth = parseInt(difficultySelect.value);
    engine.postMessage('position fen ' + fen);
    engine.postMessage('go depth ' + depth);
    waitingForEngineMove = true;
  }

  function onDragStart(source, piece, position, orientation) {
    if (game.game_over()) return false;

    if (modeSelect.value === 'stockfish') {
      if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
      }
    }

    if (game.turn() === 'w' && piece.search(/^b/) !== -1) return false;
    if (game.turn() === 'b' && piece.search(/^w/) !== -1) return false;

    return true;
  }

  function onDrop(source, target) {
    const move = game.move({from: source, to: target, promotion:'q'});
    if (move === null) return 'snapback';

    board.position(game.fen());
    updateStatus();

    if (modeSelect.value === 'stockfish' && !game.game_over()) {
      setTimeout(() => requestEngineMove(), 300);
    }
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  function resetGame() {
    game.reset();
    board.start();
    updateStatus();
    if (modeSelect.value === 'stockfish') {
      waitingForEngineMove = false;
      if (!engine) createEngine();
      setTimeout(() => {
        if (game.turn() !== playerColor) {
          requestEngineMove();
        }
      }, 400);
    } else {
      if (engine) {
        engine.terminate();
        engine = null;
        engineReady = false;
      }
    }
  }

  modeSelect.addEventListener('change', () => {
    if (modeSelect.value === 'stockfish') {
      difficultySelect.style.display = 'inline-block';
      createEngine();
    } else {
      difficultySelect.style.display = 'none';
      if (engine) {
        engine.terminate();
        engine =