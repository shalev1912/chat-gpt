<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>משחק שחמט - 2 שחקנים ובוט</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<style>
  @keyframes bgGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(-45deg, #1e3c72, #2a5298, #4b6cb7, #182848);
    background-size: 400% 400%; animation: bgGradient 20s ease infinite;
    color: #d0d6f9; text-align: center; padding: 25px; user-select: none;
  }
  h1 { font-weight: 700; font-size: 2.2rem; margin-bottom: 12px; text-shadow: 0 0 6px #6a63ffaa; }
  #board { width: 400px; margin: 20px auto; border-radius: 14px; box-shadow: 0 8px 24px rgba(106,99,255,0.3); }
  .chessboard { border-radius: 14px !important; box-shadow: 0 10px 20px rgba(106,99,255,0.3); }
  #status { margin: 18px auto; font-size: 20px; font-weight: 600; color: #a3b1ff; text-shadow: 0 0 4px #8e8dff88; animation: pulse 2.5s infinite; }
  @keyframes pulse { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
  #controls { margin: 25px auto 0; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }

  /* עיצוב כפתורים חדש */
  .game-btn {
    padding: 12px 20px;
    font-size: 17px;
    font-weight: 600;
    background: linear-gradient(45deg, #4b6cb7, #2a5298);
    color: #fff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.3s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  }
  .game-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.4);
  }
  .game-btn:disabled {
    background: #555;
    color: #bbb;
    cursor: not-allowed;
    box-shadow: none;
  }
  .home-btn {
    background: linear-gradient(45deg, #d9534f, #c9302c);
  }
  .home-btn:hover {
    box-shadow: 0 5px 12px rgba(217, 83, 79, 0.6);
  }

  select {
    font-size:16px;
    padding:8px 12px;
    border-radius:10px;
    border:2px solid #5f72be;
    background-color:#394b82;
    color:#dbe1ff;
    font-weight:600;
    box-shadow:0 3px 10px rgba(95,114,190,0.5);
  }
  select:disabled {
    background-color:#3b4262;
    border-color:#666d8a;
    color:#8b8fbd;
  }
  @media (max-width:420px){ #board{width:320px;} }
</style>
</head>
<body>
<h1>משחק שחמט - 2 שחקנים או מול בוט</h1>
<div id="board"></div>
<div id="status"></div>
<div id="controls">
  <button id="btnPvP" type="button" class="game-btn">שחק 2 שחקנים</button>
  <button id="btnPvBot" type="button" class="game-btn">שחק מול בוט</button>
  <select id="botLevel" title="רמת הבוט" disabled>
    <option value="random">רנדומלי (קל)</option>
    <option value="easy">קל - חיפוש עומק 1</option>
    <option value="medium" selected>בינוני - חיפוש עומק 2</option>
  </select>
  <button id="btnRestart" type="button" class="game-btn">התחל מחדש</button>
  <button id="btnHome" type="button" class="game-btn home-btn">חזרה</button>
</div>

<!-- ספריות -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>

<script>
  const statusEl = document.getElementById('status');
  const btnPvP = document.getElementById('btnPvP');
  const btnPvBot = document.getElementById('btnPvBot');
  const btnRestart = document.getElementById('btnRestart');
  const btnHome = document.getElementById('btnHome');
  const botLevelSelect = document.getElementById('botLevel');

  let board = null;
  let game = new Chess();
  let gameMode = 'pvp';
  let botLevel = botLevelSelect.value;
  const playerColor = 'w';
  let isGameOver = false;

  const pieceValues = { p:10, n:30, b:30, r:50, q:90, k:900 };

  function updateControlsUI(){
    if(gameMode === 'pvp'){
      btnPvP.disabled = true;
      btnPvBot.disabled = false;
      botLevelSelect.disabled = true;
    } else {
      btnPvP.disabled = false;
      btnPvBot.disabled = true;
      botLevelSelect.disabled = false;
    }
  }

  function updateStatus(){
    let status = '';
    const moveColor = game.turn() === 'w' ? 'לבן' : 'שחור';
    if (game.in_checkmate()) {
      status = 'שחמט - ' + (moveColor === 'לבן' ? 'שחור' : 'לבן') + ' ניצח!';
      isGameOver = true;
    } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material) {
      status = 'תיקו!';
      isGameOver = true;
    } else if (game.in_check()) {
      status = moveColor + ' בשח - תיזהר!';
    } else {
      status = 'תור ל-' + moveColor;
    }
    statusEl.innerText = status;
  }

  function onDragStart(source, piece) {
    if (isGameOver) return false;
    if (!piece) return false;
    if (gameMode === 'pvbot' && game.turn() !== playerColor) return false;
    if (gameMode === 'pvp' && piece[0] !== game.turn()) return false;
  }

  function onDrop(source, target) {
    if (isGameOver) return 'snapback';
    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';
    board.position(game.fen());
    updateStatus();
    if (gameMode === 'pvbot' && !isGameOver) {
      setTimeout(makeBotMove, 220);
    }
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  function initBoard() {
    board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd,
      pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });
  }

  function evaluateBoard(gameInstance) {
    const b = gameInstance.board();
    let total = 0;
    for (let row of b) {
      for (let p of row) {
        if (p !== null) {
          total += (p.color === 'w' ? 1 : -1) * (pieceValues[p.type] || 0);
        }
      }
    }
    return total;
  }

  function minimax(depth, gameInstance, isMaximizingPlayer) {
    if (depth === 0 || gameInstance.game_over()) {
      return evaluateBoard(gameInstance);
    }
    const moves = gameInstance.moves();
    if (isMaximizingPlayer) {
      let maxEval = -Infinity;
      for (let m of moves) {
        gameInstance.move(m);
        maxEval = Math.max(maxEval, minimax(depth - 1, gameInstance, false));
        gameInstance.undo();
      }
      return maxEval;
    } else {
      let minEval = Infinity;
      for (let m of moves) {
        gameInstance.move(m);
        minEval = Math.min(minEval, minimax(depth - 1, gameInstance, true));
        gameInstance.undo();
      }
      return minEval;
    }
  }

  function minimaxRoot(depth, gameInstance, isMaximizingPlayer) {
    const moves = gameInstance.moves();
    let bestMove = moves[0];
    let bestValue = -Infinity;
    for (let m of moves) {
      gameInstance.move(m);
      const val = minimax(depth - 1, gameInstance, !isMaximizingPlayer);
      gameInstance.undo();
      if (val > bestValue) { bestValue = val; bestMove = m; }
    }
    return bestMove;
  }

  function makeBotMove() {
    if (isGameOver || game.turn() !== 'b') return;
    const moves = game.moves();
    if (moves.length === 0) return;
    let chosen;
    if (botLevel === 'random') {
      chosen = moves[Math.floor(Math.random() * moves.length)];
    } else {
      const depth = botLevel === 'easy' ? 1 : 2;
      chosen = minimaxRoot(depth, game, true);
    }
    game.move(chosen);
    board.position(game.fen());
    updateStatus();
  }

  btnPvP.onclick = () => { gameMode = 'pvp'; updateControlsUI(); startGame(); };
  btnPvBot.onclick = () => { gameMode = 'pvbot'; botLevel = botLevelSelect.value; updateControlsUI(); startGame(); };
  btnRestart.onclick = () => startGame();
  botLevelSelect.onchange = (e) => { botLevel = e.target.value; };
  btnHome.onclick = () => { window.location.href = 'index.html'; };

  function startGame() {
    game = new Chess();
    isGameOver = false;
    updateStatus();
    board.start();
    board.position(game.fen());
    if (gameMode === 'pvbot' && game.turn() !== playerColor) {
      setTimeout(makeBotMove, 200);
    }
  }

  window.addEventListener('load', () => {
    initBoard();
    updateControlsUI();
    startGame();
  });
</script>
</body>
</html>