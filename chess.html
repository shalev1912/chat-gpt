<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>משחק שחמט מקצועי נגד Stockfish</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Heebo', sans-serif;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
  }
  h1 {
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 2rem;
  }
  .controls {
    margin-bottom: 20px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }
  select, button {
    font-size: 1rem;
    padding: 10px 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 700;
  }
  select { min-width: 150px; color:#222; }
  button {
    background: #6a5acd;
    color: white;
    transition: background-color 0.2s;
  }
  button:hover { background: #5548b6; }
  #difficultySelect { display: none; }
  #board {
    width: 480px;
    max-width: 90vw;
    margin-bottom: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    background: #eee;
  }
  #status {
    font-weight: 700;
    min-height: 32px;
    font-size: 1.2rem;
    text-align: center;
    margin-bottom: 15px;
  }
  @media (max-width: 520px) { #board { width: 95vw; } }
  a#backHome {
    margin-top: auto;
    color: #eee;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
  }
  a#backHome:hover { color: #b8b8ff; }
</style>

<!-- ספריות chessboardjs ו-chess.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<!-- Stockfish כ-Worker מה-CDN -->
<!-- עובד כ-Worker חיצוני: -->
<script>
  const STOCKFISH_URL = "https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.js";
</script>
</head>
<body>

<h1>משחק שחמט מקצועי</h1>

<div class="controls" role="region" aria-label="בחירת מצב ורמת קושי">
  <select id="modeSelect" aria-label="בחר מצב משחק">
    <option value="human">שחק נגד שחקן</option>
    <option value="stockfish">שחק נגד Stockfish</option>
  </select>

  <select id="difficultySelect" aria-label="בחר רמת קושי">
    <option value="4">קל (עומק 4)</option>
    <option value="8" selected>בינוני (עומק 8)</option>
    <option value="12">קשה (עומק 12)</option>
  </select>

  <button id="restartBtn" aria-label="התחל משחק חדש">התחל משחק חדש</button>
  <button id="undoBtn" aria-label="בטל מהלך">בטל מהלך</button>
  <button id="resignBtn" aria-label="ויתור">וויתר</button>
</div>

<div id="board"></div>
<div id="status" role="status" aria-live="polite">מוכן.</div>

<a id="backHome" href="https://shalev1912.github.io/chat-gpt/home.html" role="link">← חזרה למסך הבית</a>

<script>
(function () {
  let board = null;
  let game = new Chess();
  let engine = null;
  let engineReady = false;
  let waitingForEngineMove = false;
  let resigned = false;

  const modeSelect = document.getElementById('modeSelect');
  const difficultySelect = document.getElementById('difficultySelect');
  const restartBtn = document.getElementById('restartBtn');
  const undoBtn = document.getElementById('undoBtn');
  const resignBtn = document.getElementById('resignBtn');
  const statusEl = document.getElementById('status');

  function setStatus(text) { statusEl.textContent = text; }

  function updateStatus() {
    if (resigned) {
      setStatus('ויתרת על המשחק. לחץ "התחל משחק חדש" כדי לשחק שוב.');
      return;
    }
    if (game.in_checkmate()) {
      setStatus('מט! המשחק נגמר.');
    } else if (game.in_draw()) {
      setStatus('תיקו!');
    } else {
      const turn = game.turn() === 'w' ? 'לבן' : 'שחור';
      if (game.in_check()) setStatus(`תור ${turn} - שח למלך!`);
      else setStatus(`תור ${turn}`);
    }
  }

  // יצירת המנוע כ-Worker חיצוני
  function createEngine() {
    destroyEngine();
    try {
      engine = new Worker(STOCKFISH_URL);
      engineReady = false;

      engine.onmessage = function (event) {
        const line = (typeof event.data === 'string') ? event.data : '';
        // console.debug('engine:', line);

        if (line === 'uciok') {
          engine.postMessage('isready');
        } else if (line === 'readyok') {
          engineReady = true;
          setStatus('Stockfish מוכן');
          // אפשר להגדיר אופציות כאן אם רוצים (Skill Level וכו')
          // engine.postMessage('setoption name Skill Level value 5');
          if (waitingForEngineMove) requestEngineMove();
        } else if (line.startsWith('bestmove')) {
          waitingForEngineMove = false;
          const tokens = line.split(/\s+/);
          const best = tokens[1]; // למשל: e2e4 או e7e8q
          if (best && best.length >= 4) {
            const from = best.substring(0,2);
            const to = best.substring(2,4);
            const promo = best.length >= 5 ? best[4] : undefined;
            try {
              game.move({ from, to, promotion: promo || 'q' });
              board.position(game.fen());
              updateStatus();
            } catch (e) {
              console.error('אי אפשר לבצע מהלך המנוע:', e);
            }
          }
        }
      };

      engine.postMessage('uci');
    } catch (e) {
      console.error(e);
      setStatus('אי אפשר להפעיל את Stockfish בדפדפן זה.');
    }
  }

  function destroyEngine() {
    if (engine) {
      try { engine.terminate(); } catch (_) {}
    }
    engine = null;
    engineReady = false;
    waitingForEngineMove = false;
  }

  function requestEngineMove() {
    if (!engine) createEngine();
    if (!engineReady) {
      waitingForEngineMove = true;
      return;
    }
    const fen = game.fen();
    const depth = parseInt(difficultySelect.value, 10) || 8;
    engine.postMessage('position fen ' + fen);
    engine.postMessage('go depth ' + depth);
    waitingForEngineMove = true;
  }

  function onDragStart (source, piece) {
    if (resigned || game.game_over()) return false;

    // במצב מנוע – לא לאפשר לגרור את כלי היריב
    if (modeSelect.value === 'stockfish') {
      if ((game.turn() === 'w' && piece.startsWith('b')) ||
          (game.turn() === 'b' && piece.startsWith('w'))) return false;
      // לחכות לתור המנוע
      if (waitingForEngineMove) return false;
    }
    // אם זה לא התור של הצבע של הכלי
    if (game.turn() === 'w' && piece.startsWith('b')) return false;
    if (game.turn() === 'b' && piece.startsWith('w')) return false;

    return true;
  }

  function onDrop (source, target) {
    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';

    board.position(game.fen());
    updateStatus();

    if (modeSelect.value === 'stockfish' && !game.game_over()) {
      setTimeout(requestEngineMove, 200);
    }
  }

  function onSnapEnd () {
    board.position(game.fen());
  }

  function resetGame() {
    resigned = false;
    game.reset();
    board.start();
    updateStatus();

    if (modeSelect.value === 'stockfish') {
      createEngine();
      // אם הלוח מתחיל מלבן, המנוע ישחק רק אחרי הלבן
      // אם תרצה שהמנוע יפתח, אפשר לקרוא כאן ל-requestEngineMove();
    } else {
      destroyEngine();
    }
  }

  function undoMove() {
    if (resigned) return;
    if (modeSelect.value === 'stockfish') {
      // לבטל את שני החצאים (שחקן + מנוע), אם אפשר
      game.undo();
      game.undo();
    } else {
      game.undo();
    }
    board.position(game.fen());
    updateStatus();
  }

  function resignGame() {
    if (game.game_over()) return;
    resigned = true;
    setStatus('ויתרת על המשחק. לחץ "התחל משחק חדש" כדי לשחק שוב.');
  }

  // יצירת הלוח
  board = Chessboard('board', {
    position: 'start',
    draggable: true,
    onDragStart,
    onDrop,
    onSnapEnd,
    pieceTheme: function(piece) {
      return 'https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/www/img/chesspieces/wikipedia/' + piece + '.png';
    }
  });

  // חיבור אירועים
  modeSelect.addEventListener('change', () => {
    if (modeSelect.value === 'stockfish') {
      difficultySelect.style.display = 'inline-block';
      createEngine();
    } else {
      difficultySelect.style.display = 'none';
      destroyEngine();
    }
    resetGame();
  });

  difficultySelect.addEventListener('change', () => {
    // שינוי רמה ישפיע על החיפושים הבאים
    setStatus('רמת הקושי עודכנה.'); 
  });

  restartBtn.addEventListener('click', resetGame);
  undoBtn.addEventListener('click', undoMove);
  resignBtn.addEventListener('click', resignGame);

  // התחלה נקייה
  difficultySelect.style.display = 'none'; // ברירת מחדל: אדם מול אדם
  updateStatus();

})();
</script>
</body>
</html>
