<!-- Rewritten clean version: removes legacy lyrics and duplicated JS blocks -->
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>גיטרה מאסטר — לימוד אקורדים ושירים</title>
  <style>
    :root{--accent:#2b6cb0;--accent-2:#4e6fae;--glass:rgba(255,255,255,0.92);--soft:#f7fbff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:Segoe UI, Tahoma, Arial, sans-serif;background:linear-gradient(135deg,#eaf6ff 0%, #f9fbff 60%);padding:28px;direction:rtl;color:#16324a}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--glass);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(30,50,90,0.06)}
    .site-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand h1{margin:0;color:var(--accent)}.brand p{margin:0;color:var(--accent-2);font-size:0.95rem}
    .tabs{display:flex;gap:8px}.tab{background:#eef6ff;color:var(--accent);padding:8px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:600}.tab.active{background:var(--accent);color:white}
    .search-row{display:flex;gap:12px;align-items:center;margin:14px 0}.search-row input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #dbeefb;background:var(--soft)}
    .grid{display:grid;gap:14px}
    .chords-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .songs-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .chord-card, .song-card{background:white;border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(30,50,90,0.04);cursor:pointer;transition:transform .14s}
    .chord-card:hover,.song-card:hover{transform:translateY(-6px)}
    .chord-name{font-weight:700;color:var(--accent)}.chord-notes{color:var(--accent-2);margin-top:6px}
    .song-title{font-weight:700;color:var(--accent)}.song-artist{color:var(--accent-2);font-size:0.95rem}
    .meta{display:flex;gap:8px;margin-top:8px}
    .play-btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:1.1em;transition:background 0.2s;box-shadow:0 2px 8px #0001}
    .play-btn:hover{background:var(--accent-2)}
    .badge{display:inline-block;padding:2px 8px;border-radius:8px;font-size:12px;background:#eef6ff;color:#2b6cb0;margin-right:4px;min-width:60px;text-align:center}
    .badge.badge-error{background:#ffeaea;color:#b02b2b}
    .badge.badge-ok{background:#eaffea;color:#2bb04e}
    .badge.badge-loading{background:#f7f7ff;color:#888}
    .badge.badge-caption{background:#fffbe6;color:#b08c2b}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #bcd; border-top:2px solid #2b6cb0; border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:6px}
    @keyframes spin{to{transform:rotate(360deg)}}

    #yt-player{max-width:720px;width:100%;height:405px;margin:0 auto;border-radius:10px;overflow:hidden}
    .chords-timeline{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .chord-item{padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--accent);font-weight:600}
    .chord-item.active{background:var(--accent);color:white}
    #captionsBox{margin-top:10px;color:#234;min-height:30px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,20,40,0.35);z-index:1200}
    .modal.open{display:flex}
    .modal-body{width:95%;max-width:920px;background:white;border-radius:12px;padding:16px}
    .modal-head{display:flex;justify-content:space-between;align-items:center}
    .close-btn{background:transparent;border:none;font-size:22px;cursor:pointer}

    @media (max-width:700px){ #yt-player{height:220px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card site-head">
      <div class="brand">
        <h1>גיטרה מאסטר</h1>
        <p>למד אקורדים, נגן שירים ותרגל במהירות</p>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="tabs">
          <button class="tab active" data-tab="chords">אקורדים</button>
          <button class="tab" data-tab="songs">שירים</button>
        </div>
        <a href="theory.html" style="margin-right:18px;font-weight:600;color:var(--accent-2);text-decoration:underline;font-size:1.08em">מעבר לעמוד תאוריה</a>
      </div>
    </div>

    <div class="card">
      <div class="search-row">
        <input id="searchInput" placeholder="חפש שיר/אמן/אקורד..." />
        <select id="chordCategoryFilter" style="min-width:90px">
          <option value="all">כל הסוגים</option>
          <option value="major">מג'ור</option>
          <option value="minor">מינור</option>
        </select>
      </div>

      <div id="chordsSection" class="grid chords-grid"></div>
      <div id="songsSection" class="grid songs-grid" style="display:none;margin-top:6px"></div>

      <div class="player-area">
        <div id="yt-player"></div>
        <div id="chordsTimeline" class="chords-timeline"></div>
        <div id="captionsBox">כתוביות יופיעו כאן כשיהיו זמינות מהוידאו</div>
      </div>
    </div>
  </div>

  <div id="songModal" class="modal" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <div>
          <h2 id="modalTitle" style="margin:0"></h2>
          <div id="modalArtist" style="color:var(--accent-2)"></div>
        </div>
        <div><button class="close-btn" id="modalClose">×</button></div>
      </div>
      <div style="margin-top:12px;text-align:center">
        <div id="modalPlayer" style="width:100%;max-width:820px;margin:0 auto"></div>
        <div id="modalChordsTimeline" class="chords-timeline"></div>
        <div id="modalCaptions" style="margin-top:8px;color:#234">כתוביות יופיעו כאן</div>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // --- Data (no lyrics) ---
    // מקצועי: אקורדים עם דיאגרמה, שם, קטגוריה, מיקום אצבעות, מיתרים פתוחים/סגורים
    const chordsData = [
      {name:'C',notes:'C E G',category:'major',diagram:[-1,3,2,0,1,0], fingers:[0,3,2,0,1,0]},
      {name:'G',notes:'G B D',category:'major',diagram:[3,2,0,0,0,3], fingers:[2,1,0,0,0,3]},
      {name:'D',notes:'D F# A',category:'major',diagram:[-1,-1,0,2,3,2], fingers:[0,0,0,1,3,2]},
      {name:'Am',notes:'A C E',category:'minor',diagram:[-1,0,2,2,1,0], fingers:[0,0,2,3,1,0]},
      {name:'Em',notes:'E G B',category:'minor',diagram:[0,2,2,0,0,0], fingers:[0,2,3,0,0,0]},
      {name:'F',notes:'F A C',category:'major',diagram:[1,3,3,2,1,1], fingers:[1,3,4,2,1,1]},
      {name:'Dm',notes:'D F A',category:'minor',diagram:[-1,-1,0,2,3,1], fingers:[0,0,0,2,3,1]},
      {name:'E',notes:'E G# B',category:'major',diagram:[0,2,2,1,0,0], fingers:[0,2,3,1,0,0]},
      {name:'A',notes:'A C# E',category:'major',diagram:[-1,0,2,2,2,0], fingers:[0,0,2,1,3,0]},
      {name:'Bb',notes:'Bb D F',category:'major',diagram:[1,1,3,3,3,1], fingers:[1,1,3,4,2,1]},
      {name:'Gm',notes:'G Bb D',category:'minor',diagram:[3,5,5,3,3,3], fingers:[1,3,4,1,1,1]},
      {name:'Bm',notes:'B D F#',category:'minor',diagram:[2,2,4,4,3,2], fingers:[1,1,4,3,2,1]},
      {name:'Ab',notes:'Ab C Eb',category:'major',diagram:[4,6,6,5,4,4], fingers:[1,3,4,2,1,1]},
      {name:'Db',notes:'Db F Ab',category:'major',diagram:[-1,4,6,6,6,4], fingers:[0,1,3,4,2,1]}
    ];

    const songsData = [
      {id:1,title:'Shape of You',artist:'Ed Sheeran',youtubeId:'JGwWNGJdvx8',chordsTimeline:[
        {time:0,chord:'C'},
        {time:4,chord:'G'},
        {time:8,chord:'Am'},
        {time:12,chord:'F'},
        {time:16,chord:'C'},
        {time:20,chord:'G'},
        {time:24,chord:'Am'},
        {time:28,chord:'F'}
      ]},
      {id:2,title:'Hello',artist:'Adele',youtubeId:'YQHsXMglC9A',chordsTimeline:[
        {time:0,chord:'Am'},
        {time:5,chord:'F'},
        {time:10,chord:'C'},
        {time:15,chord:'G'},
        {time:20,chord:'Am'},
        {time:25,chord:'F'},
        {time:30,chord:'C'},
        {time:35,chord:'G'}
      ]},
      {id:3,title:'Smells Like Teen Spirit',artist:'Nirvana',youtubeId:'hTWKbfoikeg',chordsTimeline:[
        {time:0,chord:'F'},
        {time:2,chord:'Bb'},
        {time:4,chord:'Ab'},
        {time:6,chord:'Db'},
        {time:8,chord:'F'},
        {time:10,chord:'Bb'},
        {time:12,chord:'Ab'},
        {time:14,chord:'Db'}
      ]},
      {id:4,title:'Yellow',artist:'Coldplay',youtubeId:'yKNxeF4KMsY',chordsTimeline:[
        {time:0,chord:'C'},
        {time:6,chord:'G'},
        {time:12,chord:'Am'},
        {time:18,chord:'F'},
        {time:24,chord:'C'},
        {time:30,chord:'G'},
        {time:36,chord:'Am'},
        {time:42,chord:'F'}
      ]},
      {id:5,title:'Bohemian Rhapsody',artist:'Queen',youtubeId:'fJ9rUzIMcZQ',chordsTimeline:[
        {time:0,chord:'Bb'},
        {time:8,chord:'Eb'},
        {time:16,chord:'C'},
        {time:24,chord:'G'},
        {time:32,chord:'Bb'},
        {time:40,chord:'Eb'},
        {time:48,chord:'C'},
        {time:56,chord:'G'}
      ]},
      {id:6,title:'Let It Be',artist:'The Beatles',youtubeId:'QDYfEBY9NM4',chordsTimeline:[
        {time:0,chord:'C'},
        {time:5,chord:'G'},
        {time:10,chord:'Am'},
        {time:15,chord:'F'},
        {time:20,chord:'C'},
        {time:25,chord:'G'},
        {time:30,chord:'F'},
        {time:35,chord:'C'}
      ]},
      {id:7,title:'Sorry',artist:'Justin Bieber',youtubeId:'fRh_vgS2dFE',chordsTimeline:[
        {time:0,chord:'Dm'},
        {time:6,chord:'Bb'},
        {time:12,chord:'F'},
        {time:18,chord:'C'},
        {time:24,chord:'Dm'},
        {time:30,chord:'Bb'},
        {time:36,chord:'F'},
        {time:42,chord:'C'}
      ]},
      {id:8,title:'Dynamite',artist:'BTS',youtubeId:'Q0oIoR9mLwc',chordsTimeline:[
        {time:0,chord:'C'},
        {time:8,chord:'Am'},
        {time:16,chord:'F'},
        {time:24,chord:'G'},
        {time:32,chord:'C'},
        {time:40,chord:'Am'},
        {time:48,chord:'F'},
        {time:56,chord:'G'}
      ]},
      {id:9,title:'מתנות קטנות',artist:'רמי קלינשטיין',youtubeId:'6l5b1LMlQ0c',chordsTimeline:[
        {time:0,chord:'G'},{time:6,chord:'D'},{time:12,chord:'Em'},{time:18,chord:'C'},{time:24,chord:'G'},{time:30,chord:'D'},{time:36,chord:'Em'},{time:42,chord:'C'},{time:48,chord:'G'},{time:54,chord:'D'},{time:60,chord:'Em'},{time:66,chord:'C'}
      ]},
      {id:10,title:'שלמים',artist:'עדן בן זקן',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[
        {time:0,chord:'Am'},{time:7,chord:'F'},{time:14,chord:'C'},{time:21,chord:'G'},{time:28,chord:'Am'},{time:35,chord:'F'},{time:42,chord:'C'},{time:49,chord:'G'}
      ]},
      // --- שירים פופולריים נוספים (דוגמה, ניתן להרחיב) ---
      {id:11,title:'Someone Like You',artist:'Adele',youtubeId:'hLQl3WQQoQ0',strumming:'↓ ↓ ↑ ↑ ↓ ↑',chordsTimeline:[{time:0,chord:'A'},{time:5,chord:'E'},{time:10,chord:'F#m'},{time:15,chord:'D'}]},
      {id:12,title:'Wonderwall',artist:'Oasis',youtubeId:'bx1Bh8ZvH84',strumming:'↓ ↓ ↑ ↑ ↓ ↑',chordsTimeline:[{time:0,chord:'Em7'},{time:4,chord:'G'},{time:8,chord:'Dsus4'},{time:12,chord:'A7sus4'}]},
      {id:13,title:'Shallow',artist:'Lady Gaga & Bradley Cooper',youtubeId:'bo_efYhYU2A',strumming:'↓ ↓ ↑ ↑ ↓ ↑',chordsTimeline:[{time:0,chord:'Em'},{time:6,chord:'D'},{time:12,chord:'G'},{time:18,chord:'C'}]},
      {id:14,title:'Hallelujah',artist:'Leonard Cohen',youtubeId:'ttEMYvpoR-k',strumming:'↓ ↓ ↑ ↑ ↓ ↑',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'Am'},{time:12,chord:'C'},{time:18,chord:'Am'}]},
      {id:15,title:'Yesterday',artist:'The Beatles',youtubeId:'NrgmdOz227I',strumming:'↓ ↑ ↓ ↑ ↓ ↑',chordsTimeline:[{time:0,chord:'F'},{time:5,chord:'Em7'},{time:10,chord:'A7'},{time:15,chord:'Dm'}]},
      {id:16,title:'Let Her Go',artist:'Passenger',youtubeId:'RBumgq5yVrA',chordsTimeline:[{time:0,chord:'C'},{time:5,chord:'D'},{time:10,chord:'Em'},{time:15,chord:'G'}]},
      {id:17,title:'Counting Stars',artist:'OneRepublic',youtubeId:'hT_nvWreIhg',chordsTimeline:[{time:0,chord:'Am'},{time:4,chord:'C'},{time:8,chord:'G'},{time:12,chord:'F'}]},
      {id:18,title:'Let It Go',artist:'Idina Menzel',youtubeId:'L0MK7qz13bU',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'Dm'},{time:12,chord:'Bb'},{time:18,chord:'C'}]},
      {id:19,title:'All of Me',artist:'John Legend',youtubeId:'450p7goxZqg',chordsTimeline:[{time:0,chord:'Em'},{time:5,chord:'C'},{time:10,chord:'G'},{time:15,chord:'D'}]},
      {id:20,title:'Perfect',artist:'Ed Sheeran',youtubeId:'2Vv-BfVoq4g',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'}]},
      {id:21,title:'Hey Jude',artist:'The Beatles',youtubeId:'A_MjCqQoLLA',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'C'},{time:12,chord:'C7'},{time:18,chord:'F'}]},
      {id:22,title:'Hotel California',artist:'Eagles',youtubeId:'EqPtz5qN7HM',chordsTimeline:[{time:0,chord:'Bm'},{time:7,chord:'F#'},{time:14,chord:'A'},{time:21,chord:'E'}]},
      {id:23,title:'Toxic',artist:'Britney Spears',youtubeId:'LOZuxwVk7TU',chordsTimeline:[{time:0,chord:'C#m'},{time:5,chord:'A'},{time:10,chord:'B'},{time:15,chord:'E'}]},
      {id:24,title:'Africa',artist:'Toto',youtubeId:'FTQbiNvZqaY',chordsTimeline:[{time:0,chord:'B'},{time:6,chord:'E'},{time:12,chord:'G#m'},{time:18,chord:'F#'}]},
      {id:25,title:'Livin’ on a Prayer',artist:'Bon Jovi',youtubeId:'lDK9QqIzhwk',chordsTimeline:[{time:0,chord:'Em'},{time:6,chord:'C'},{time:12,chord:'D'},{time:18,chord:'G'}]},
      {id:26,title:'Shape of My Heart',artist:'Sting',youtubeId:'locIxsfpgp4',chordsTimeline:[{time:0,chord:'Am'},{time:5,chord:'Dm'},{time:10,chord:'G'},{time:15,chord:'C'}]},
      {id:27,title:'Sweet Child O’ Mine',artist:'Guns N’ Roses',youtubeId:'1w7OgIMMRc4',chordsTimeline:[{time:0,chord:'D'},{time:6,chord:'C'},{time:12,chord:'G'},{time:18,chord:'A'}]},
      {id:28,title:'Fix You',artist:'Coldplay',youtubeId:'k4V3Mo61fJM',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'Em'},{time:12,chord:'Am'},{time:18,chord:'F'}]},
      {id:29,title:'Take Me to Church',artist:'Hozier',youtubeId:'PVjiKRfKpPI',chordsTimeline:[{time:0,chord:'Em'},{time:6,chord:'C'},{time:12,chord:'G'},{time:18,chord:'D'}]},
      {id:30,title:'Counting Stars',artist:'OneRepublic',youtubeId:'hT_nvWreIhg',chordsTimeline:[{time:0,chord:'Am'},{time:4,chord:'C'},{time:8,chord:'G'},{time:12,chord:'F'}]},
      {id:31,title:'Despacito',artist:'Luis Fonsi',youtubeId:'kJQP7kiw5Fk',chordsTimeline:[{time:0,chord:'Bm'},{time:6,chord:'G'},{time:12,chord:'D'},{time:18,chord:'A'}]},
      {id:32,title:'Let’s Get Loud',artist:'Jennifer Lopez',youtubeId:'74eJaVQFybI',chordsTimeline:[{time:0,chord:'Am'},{time:5,chord:'F'},{time:10,chord:'C'},{time:15,chord:'G'}]},
      {id:33,title:'Shir LaShalom',artist:'Miri Aloni',youtubeId:'dQw4w9WgXcQ',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'F'},{time:12,chord:'G'},{time:18,chord:'C'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'C'},{time:42,chord:'F'}]},
      {id:34,title:'Od Yavo Shalom Aleinu',artist:'Mosh Ben Ari',youtubeId:'Q2v2tF6b9rM',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'G'},{time:12,chord:'F'},{time:18,chord:'E'},{time:24,chord:'Am'},{time:30,chord:'G'},{time:36,chord:'F'},{time:42,chord:'E'}]},
      {id:35,title:'Yerushalayim Shel Zahav',artist:'Naomi Shemer',youtubeId:'bG5N3GCgmIE',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:36,title:'Erev Shel Shoshanim',artist:'Yafa Yarkoni',youtubeId:'w6l5b1LMlQ0c',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'Dm'},{time:12,chord:'E'},{time:18,chord:'Am'},{time:24,chord:'Dm'},{time:30,chord:'E'},{time:36,chord:'Am'},{time:42,chord:'Dm'}]},
      {id:37,title:'Hallelujah',artist:'Milk & Honey',youtubeId:'p6U6Pci8gzw',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'F'},{time:12,chord:'G'},{time:18,chord:'C'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'C'},{time:42,chord:'F'}]},
      {id:38,title:'Siman Sheata Tzair',artist:'Eyal Golan',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:39,title:'Mekofef',artist:'Hanan Ben Ari',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:40,title:'Ten Li Yad',artist:'Eliad',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:41,title:'Bad Guy',artist:'Billie Eilish',youtubeId:'DyDfgMOUjCI',chordsTimeline:[{time:0,chord:'Em'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'B'}]},
      {id:42,title:'Blinding Lights',artist:'The Weeknd',youtubeId:'fHI8X4OXluQ',chordsTimeline:[{time:0,chord:'F#m'},{time:6,chord:'C#m'},{time:12,chord:'E'},{time:18,chord:'A'}]},
      {id:43,title:'Dance Monkey',artist:'Tones and I',youtubeId:'q0hyYWKXF0Q',chordsTimeline:[{time:0,chord:'Em'},{time:6,chord:'C'},{time:12,chord:'D'},{time:18,chord:'B7'}]},
      {id:44,title:'Senorita',artist:'Shawn Mendes & Camila Cabello',youtubeId:'Pkh8UtuejGw',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'}]},
      {id:45,title:'Havana',artist:'Camila Cabello',youtubeId:'HCjNJDNzw8Y',chordsTimeline:[{time:0,chord:'Dm'},{time:6,chord:'Em'},{time:12,chord:'A'},{time:18,chord:'G'}]},
      {id:46,title:'Shivers',artist:'Ed Sheeran',youtubeId:'Il0S8BoucSA',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'}]},
      {id:47,title:'Levitating',artist:'Dua Lipa',youtubeId:'TUVcZfQe-Kw',chordsTimeline:[{time:0,chord:'Bm'},{time:6,chord:'Em'},{time:12,chord:'A'},{time:18,chord:'D'}]},
      {id:48,title:'Watermelon Sugar',artist:'Harry Styles',youtubeId:'E07s5ZYygMg',chordsTimeline:[{time:0,chord:'D'},{time:6,chord:'Bm'},{time:12,chord:'G'},{time:18,chord:'A'}]},
      {id:49,title:'Drivers License',artist:'Olivia Rodrigo',youtubeId:'ZmDBbnmKpqQ',chordsTimeline:[{time:0,chord:'Bb'},{time:6,chord:'Gm'},{time:12,chord:'Eb'},{time:18,chord:'F'}]},
      {id:50,title:'Stay',artist:'The Kid LAROI & Justin Bieber',youtubeId:'kTJczUoc26U',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'Em'}]},
      // עברית
  {id:51,title:'ילדים כאלה',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'}]}, // אין קליפ רשמי, נשאר דמה
  {id:52,title:'שני משוגעים',artist:'עומר אדם',youtubeId:'h3h035Eyz5A',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'}]},
  {id:53,title:'בסוף כל יום',artist:'ישי ריבו',youtubeId:'wFhku3pGg6g',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'}]},
  {id:54,title:'שבט אחים ואחיות',artist:'עידן רפאל חביב',youtubeId:'Jk1bGkA1uA0',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'}]},
  {id:55,title:'מישהו איתי כאן',artist:'עדן חסון',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'}]}, // אין קליפ רשמי
  {id:56,title:'החיים שלנו תותים',artist:'עידן יניב',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'}]}, // אין קליפ רשמי
  {id:57,title:'אולי נדבר',artist:'ישי ריבו',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'}]}, // אין קליפ רשמי
  {id:58,title:'הכול זה מלמעלה',artist:'עומר אדם',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'}]}, // אין קליפ רשמי
  {id:59,title:'שיר למעלות',artist:'מאיר בנאי',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'}]}, // אין קליפ רשמי
  {id:60,title:'ממעמקים',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'}]}, // אין קליפ רשמי
      {id:61,title:'Hallelujah',artist:'Leonard Cohen',youtubeId:'ttEMYvpoR-k',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'Am'},{time:12,chord:'C'},{time:18,chord:'Am'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:62,title:'Yesterday',artist:'The Beatles',youtubeId:'NrgmdOz227I',strumming:'D U D U D U',chordsTimeline:[{time:0,chord:'F'},{time:5,chord:'Em7'},{time:10,chord:'A7'},{time:15,chord:'Dm'},{time:20,chord:'C'},{time:25,chord:'Bb'},{time:30,chord:'C'},{time:35,chord:'F'}]},
      {id:63,title:'Let Her Go',artist:'Passenger',youtubeId:'RBumgq5yVrA',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:5,chord:'D'},{time:10,chord:'Em'},{time:15,chord:'G'},{time:20,chord:'C'},{time:25,chord:'D'},{time:30,chord:'Em'},{time:35,chord:'G'}]},
      {id:64,title:'Counting Stars',artist:'OneRepublic',youtubeId:'hT_nvWreIhg',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:4,chord:'C'},{time:8,chord:'G'},{time:12,chord:'F'},{time:16,chord:'Am'},{time:20,chord:'C'},{time:24,chord:'G'},{time:28,chord:'F'}]},
      {id:65,title:'Let It Go',artist:'Idina Menzel',youtubeId:'L0MK7qz13bU',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'Dm'},{time:12,chord:'Bb'},{time:18,chord:'C'},{time:24,chord:'F'},{time:30,chord:'Dm'},{time:36,chord:'Bb'},{time:42,chord:'C'}]},
      {id:66,title:'All of Me',artist:'John Legend',youtubeId:'450p7goxZqg',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Em'},{time:5,chord:'C'},{time:10,chord:'G'},{time:15,chord:'D'},{time:20,chord:'Em'},{time:25,chord:'C'},{time:30,chord:'G'},{time:35,chord:'D'}]},
      {id:67,title:'Perfect',artist:'Ed Sheeran',youtubeId:'2Vv-BfVoq4g',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:68,title:'Hey Jude',artist:'The Beatles',youtubeId:'A_MjCqQoLLA',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'C'},{time:12,chord:'C7'},{time:18,chord:'F'},{time:24,chord:'Bb'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'F'}]},
      {id:69,title:'Hotel California',artist:'Eagles',youtubeId:'EqPtz5qN7HM',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Bm'},{time:7,chord:'F#'},{time:14,chord:'A'},{time:21,chord:'E'},{time:28,chord:'G'},{time:35,chord:'D'},{time:42,chord:'Em'},{time:49,chord:'F#'}]},
      {id:70,title:'Toxic',artist:'Britney Spears',youtubeId:'LOZuxwVk7TU',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C#m'},{time:5,chord:'A'},{time:10,chord:'B'},{time:15,chord:'E'},{time:20,chord:'C#m'},{time:25,chord:'A'},{time:30,chord:'B'},{time:35,chord:'E'}]},
      // --- Hebrew songs ---
      {id:71,title:'שיר אהבה בדואי',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:72,title:'החיים שלנו תותים',artist:'עידן יניב',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:73,title:'בסוף כל יום',artist:'ישי ריבו',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:74,title:'שבט אחים ואחיות',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:75,title:'ילדים כאלה',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:76,title:'שני משוגעים',artist:'עומר אדם',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:77,title:'הכול זה מלמעלה',artist:'עומר אדם',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:78,title:'שיר למעלות',artist:'מאיר בנאי',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:79,title:'ממעמקים',artist:'עידן רפאל חביב',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:80,title:'אולי נדבר',artist:'ישי ריבו',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:81,title:'Shir LaShalom',artist:'Miri Aloni',youtubeId:'dQw4w9WgXcQ',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'F'},{time:12,chord:'G'},{time:18,chord:'C'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'C'},{time:42,chord:'F'}]},
      {id:82,title:'Od Yavo Shalom Aleinu',artist:'Mosh Ben Ari',youtubeId:'Q2v2tF6b9rM',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'G'},{time:12,chord:'F'},{time:18,chord:'E'},{time:24,chord:'Am'},{time:30,chord:'G'},{time:36,chord:'F'},{time:42,chord:'E'}]},
      {id:83,title:'Yerushalayim Shel Zahav',artist:'Naomi Shemer',youtubeId:'bG5N3GCgmIE',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:84,title:'Erev Shel Shoshanim',artist:'Yafa Yarkoni',youtubeId:'w6l5b1LMlQ0c',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'Dm'},{time:12,chord:'E'},{time:18,chord:'Am'},{time:24,chord:'Dm'},{time:30,chord:'E'},{time:36,chord:'Am'},{time:42,chord:'Dm'}]},
      {id:85,title:'Hallelujah',artist:'Milk & Honey',youtubeId:'p6U6Pci8gzw',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'F'},{time:12,chord:'G'},{time:18,chord:'C'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'C'},{time:42,chord:'F'}]},
      {id:86,title:'Siman Sheata Tzair',artist:'Eyal Golan',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'Em'},{time:12,chord:'C'},{time:18,chord:'D'},{time:24,chord:'G'},{time:30,chord:'Em'},{time:36,chord:'C'},{time:42,chord:'D'}]},
      {id:87,title:'Mekofef',artist:'Hanan Ben Ari',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:88,title:'Ten Li Yad',artist:'Eliad',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:89,title:'שלמים',artist:'עדן בן זקן',youtubeId:'Qw7GmrYu6eY',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:7,chord:'F'},{time:14,chord:'C'},{time:21,chord:'G'},{time:28,chord:'Am'},{time:35,chord:'F'},{time:42,chord:'C'},{time:49,chord:'G'}]},
      {id:90,title:'מתנות קטנות',artist:'רמי קלינשטיין',youtubeId:'6l5b1LMlQ0c',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'G'},{time:6,chord:'D'},{time:12,chord:'Em'},{time:18,chord:'C'},{time:24,chord:'G'},{time:30,chord:'D'},{time:36,chord:'Em'},{time:42,chord:'C'}]},
      // --- More English songs ---
      {id:91,title:'Viva La Vida',artist:'Coldplay',youtubeId:'dvgZkm1xWPE',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'D'},{time:12,chord:'G'},{time:18,chord:'Em'},{time:24,chord:'C'},{time:30,chord:'D'},{time:36,chord:'G'},{time:42,chord:'Em'}]},
      {id:92,title:'Let Me Down Slowly',artist:'Alec Benjamin',youtubeId:'50VNCymT-Cs',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:6,chord:'F'},{time:12,chord:'C'},{time:18,chord:'G'},{time:24,chord:'Am'},{time:30,chord:'F'},{time:36,chord:'C'},{time:42,chord:'G'}]},
      {id:93,title:'Shivers',artist:'Ed Sheeran',youtubeId:'Il0S8BoucSA',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'C'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'F'},{time:24,chord:'C'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'F'}]},
      {id:94,title:'Levitating',artist:'Dua Lipa',youtubeId:'TUVcZfQe-Kw',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Bm'},{time:6,chord:'Em'},{time:12,chord:'A'},{time:18,chord:'D'},{time:24,chord:'Bm'},{time:30,chord:'Em'},{time:36,chord:'A'},{time:42,chord:'D'}]},
      {id:95,title:'Watermelon Sugar',artist:'Harry Styles',youtubeId:'E07s5ZYygMg',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'D'},{time:6,chord:'Bm'},{time:12,chord:'G'},{time:18,chord:'A'},{time:24,chord:'D'},{time:30,chord:'Bm'},{time:36,chord:'G'},{time:42,chord:'A'}]},
      {id:96,title:'Drivers License',artist:'Olivia Rodrigo',youtubeId:'ZmDBbnmKpqQ',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Bb'},{time:6,chord:'Gm'},{time:12,chord:'Eb'},{time:18,chord:'F'},{time:24,chord:'Bb'},{time:30,chord:'Gm'},{time:36,chord:'Eb'},{time:42,chord:'F'}]},
      {id:97,title:'Stay',artist:'The Kid LAROI & Justin Bieber',youtubeId:'kTJczUoc26U',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'F'},{time:6,chord:'G'},{time:12,chord:'Am'},{time:18,chord:'Em'},{time:24,chord:'F'},{time:30,chord:'G'},{time:36,chord:'Am'},{time:42,chord:'Em'}]},
      {id:98,title:'Despacito',artist:'Luis Fonsi',youtubeId:'kJQP7kiw5Fk',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Bm'},{time:6,chord:'G'},{time:12,chord:'D'},{time:18,chord:'A'},{time:24,chord:'Bm'},{time:30,chord:'G'},{time:36,chord:'D'},{time:42,chord:'A'}]},
      {id:99,title:'Let’s Get Loud',artist:'Jennifer Lopez',youtubeId:'74eJaVQFybI',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'Am'},{time:5,chord:'F'},{time:10,chord:'C'},{time:15,chord:'G'},{time:20,chord:'Am'},{time:25,chord:'F'},{time:30,chord:'C'},{time:35,chord:'G'}]},
      {id:100,title:'Sweet Child O’ Mine',artist:'Guns N’ Roses',youtubeId:'1w7OgIMMRc4',strumming:'D D U U D U',chordsTimeline:[{time:0,chord:'D'},{time:6,chord:'C'},{time:12,chord:'G'},{time:18,chord:'A'},{time:24,chord:'D'},{time:30,chord:'C'},{time:36,chord:'G'},{time:42,chord:'A'}]},
    ]; // סוף הגדרת songsData

    // הוספת שירים בעברית אחרי הגדרת המערך
    songsData.push(
      {id:9,title:'מתנות קטנות',artist:'רמי קלינשטיין',youtubeId:'6l5b1LMlQ0c',chordsTimeline:[
        {time:0,chord:'G'},{time:6,chord:'D'},{time:12,chord:'Em'},{time:18,chord:'C'},{time:24,chord:'G'},{time:30,chord:'D'},{time:36,chord:'Em'},{time:42,chord:'C'},{time:48,chord:'G'},{time:54,chord:'D'},{time:60,chord:'Em'},{time:66,chord:'C'}
      ]},
      {id:10,title:'שלמים',artist:'עדן בן זקן',youtubeId:'Qw7GmrYu6eY',chordsTimeline:[
        {time:0,chord:'Am'},{time:7,chord:'F'},{time:14,chord:'C'},{time:21,chord:'G'},{time:28,chord:'Am'},{time:35,chord:'F'},{time:42,chord:'C'},{time:49,chord:'G'}
      ]}
    );

    // --- YouTube player and sync ---
    let ytPlayer = null;
    let activeTimeline = [];
    let timelineInterval = null;
    let timelineSyncTarget = 'chordsTimeline';
    let lastPlayerState = -1;

    function onYouTubeIframeAPIReady(){ /* YT API ready */ }

    // Create or load a player in the given container. If autoplay true, play when ready.
    function createPlayer(containerId, videoId, autoplay=false){
      const opts = {
        videoId: videoId,
        width: '100%',
        height: '405',
        playerVars: {playsinline:1}
      };

      // If no YT available yet, try later
      if(typeof YT === 'undefined' || !YT.Player){
        console.warn('YouTube API not ready yet');
        // still create an iframe fallback
        const container = document.getElementById(containerId);
        if(container) container.innerHTML = `<iframe width="100%" height="405" src="https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1${autoplay? '&autoplay=1':''}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
        return;
      }

      // If there's an existing player, destroy it (we reuse a single global instance)
      try{ if(ytPlayer && ytPlayer.destroy) ytPlayer.destroy(); }catch(e){}

      ytPlayer = new YT.Player(containerId, Object.assign({}, opts, {
        events: {
          onReady: function(ev){ if(autoplay && ev.target.playVideo) ev.target.playVideo(); },
          onStateChange: function(ev){
            lastPlayerState = ev.data;
            // 1 = playing, 2 = paused, 0 = ended, 3 = buffering, -1 = unstarted
            if(ev.data === 1){ // playing
              if(timelineInterval) clearInterval(timelineInterval);
              timelineInterval = setInterval(()=>syncChords(timelineSyncTarget), 220);
              startCaptionsSync('captionsBox', ytPlayer);
            } else {
              if(timelineInterval) clearInterval(timelineInterval);
              stopCaptionsSync();
            }
            // always sync once on state change (for seek, pause, etc)
            syncChords(timelineSyncTarget);
          }
        }
      }));
    }

    function setChordsTimeline(data, targetId='chordsTimeline', strumming){
      activeTimeline = Array.isArray(data) ? data : [];
      timelineSyncTarget = targetId;
      const el = document.getElementById(targetId);
      if(!el) return;
      // תצוגה בסגנון chordify: פס זמן רציף עם אקורדים
      el.innerHTML = `<div style='overflow-x:auto;white-space:nowrap;padding-bottom:6px;'>` +
        activeTimeline.map((c,i)=>`<span class='chord-item' id='${targetId}-chord-${i}' style='display:inline-block;margin-left:8px;margin-right:8px;font-size:1.15em'>${c.chord}</span>`).join('') +
        `</div>` +
        (strumming ? `<div style='margin-top:4px;font-size:0.95em;color:#4e6fae'>Strumming: <b>${strumming}</b></div>` : '');
      if(timelineInterval) clearInterval(timelineInterval);
      if(ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === 1){
        timelineInterval = setInterval(()=>syncChords(targetId), 220);
      } else {
        syncChords(targetId);
      }
    }

    function setChordsTimeline(data, targetId='chordsTimeline'){
      activeTimeline = Array.isArray(data) ? data : [];
      timelineSyncTarget = targetId;
      const el = document.getElementById(targetId);
      if(!el) return;
      // תצוגה בסגנון chordify: פס זמן רציף עם אקורדים
      el.innerHTML = `<div style='overflow-x:auto;white-space:nowrap;padding-bottom:6px;'>` +
        activeTimeline.map((c,i)=>`<span class='chord-item' id='${targetId}-chord-${i}' style='display:inline-block;margin-left:8px;margin-right:8px;font-size:1.15em'>${c.chord}</span>`).join('') +
        `</div>`;
      if(timelineInterval) clearInterval(timelineInterval);
      if(ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === 1){
        timelineInterval = setInterval(()=>syncChords(targetId), 220);
      } else {
        syncChords(targetId);
      }
    }

    function syncChords(targetId='chordsTimeline'){
      if(!activeTimeline.length || !ytPlayer || !ytPlayer.getCurrentTime) return;
      const t = ytPlayer.getCurrentTime();
      let idx = 0;
      for(let i=0;i<activeTimeline.length;i++){
        if(t >= activeTimeline[i].time) idx = i;
      }
      // הדגשת האקורד הנוכחי
      for(let i=0;i<activeTimeline.length;i++){
        const el = document.getElementById(`${targetId}-chord-${i}`);
        if(el) el.style.background = (i===idx) ? '#ffe066' : '';
        if(el) el.style.borderRadius = (i===idx) ? '6px' : '';
        if(el) el.style.padding = (i===idx) ? '2px 8px' : '';
        if(el) el.style.fontWeight = (i===idx) ? 'bold' : '';
        if(el) el.style.boxShadow = (i===idx) ? '0 2px 8px #ffe06688' : '';
      }
    }

    // --- Captions sync logic ---
    let captionsSyncInterval = null;
    let captionsData = [];
    function syncCaptionsToPlayer(targetId, player) {
      if (!player || !player.getCurrentTime || !Array.isArray(captionsData) || captionsData.length === 0) return;
      const t = player.getCurrentTime();
      let idx = -1;
      for (let i = 0; i < captionsData.length; i++) {
        if (t >= captionsData[i].start) idx = i;
        else break;
      }
      const el = document.getElementById(targetId);
      if (el) {
        if (idx >= 0) el.textContent = captionsData[idx].text;
        else el.textContent = '';
      }
    }

    function startCaptionsSync(targetId, player) {
      if (captionsSyncInterval) clearInterval(captionsSyncInterval);
      captionsSyncInterval = setInterval(() => syncCaptionsToPlayer(targetId, player), 250);
    }
    function stopCaptionsSync() {
      if (captionsSyncInterval) clearInterval(captionsSyncInterval);
      captionsSyncInterval = null;
    }

    // Captions placeholder
    function setCaptionsPlaceholder(targetId, text){
      const el=document.getElementById(targetId);
      if(!el) return;
      if(text && text.startsWith('<')) el.innerHTML = text;
      else el.textContent = text || 'כתוביות לא זמינות';
    }

    // Check video availability via YouTube oEmbed (graceful fallback)
    async function checkVideoAvailable(youtubeId){
      try{
        // First try oEmbed (fast, no key)
        const url = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${youtubeId}&format=json`;
        const res = await fetch(url);
        if(res.ok) return true;
      }catch(e){ /* fallthrough */ }
      try{
        // fallback to our server which uses API key
        const r2 = await fetch(`/api/youtube/video?id=${encodeURIComponent(youtubeId)}`);
        const j = await r2.json();
        return j && j.ok && Array.isArray(j.items) && j.items.length>0;
      }catch(e){ return false; }
    }

    // --- Rendering UI ---
    const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));

    // סינון אקורדים לפי חיפוש/סוג
    function filterChords(query, category) {
      let arr = chordsData;
      if (category && category !== 'all') arr = arr.filter(c => c.category === category);
      if (query) arr = arr.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
      return arr;
    }

    function renderChords(filterQ = '', filterCat = 'all'){
      const el = document.getElementById('chordsSection'); el.innerHTML = '';
      const sorted = filterChords(filterQ, filterCat).slice().sort((a,b)=>a.name.localeCompare(b.name));
      sorted.forEach(c=>{
        const d = document.createElement('div'); d.className='chord-card';
        d.innerHTML = `
          <div class='chord-name'>${c.name}</div>
          <div class='chord-diagram'>${renderChordDiagram(c.diagram, c.fingers)}</div>
          <div class='chord-notes'>${c.notes} <span style='color:#888;font-size:0.9em'>(${c.category})</span></div>
        `;
        d.addEventListener('click', ()=>{ alert('אקורד: '+c.name+'\nמיתרים: '+c.diagram.join(', ')); });
        el.appendChild(d);
      });
    }

    // ציור דיאגרמת אקורד (מיתר 6 משמאל, 1 מימין, 5 סריגים)
    function renderChordDiagram(diagram, fingers){
      let html = `<svg width='60' height='70' viewBox='0 0 60 70'>`;
      // קווי מיתרים (6->1, שמאל לימין)
      for(let i=0;i<6;i++) html += `<line x1='${10+i*8}' y1='20' x2='${10+i*8}' y2='60' stroke='#bbb' stroke-width='1'/>`;
      // קווי סריגים
      for(let f=0;f<=4;f++) html += `<line x1='10' y1='${20+f*10}' x2='50' y2='${20+f*10}' stroke='#bbb' stroke-width='1'/>`;
      // מספור מיתרים
      for(let i=0;i<6;i++) html += `<text x='${8+i*8}' y='68' font-size='7' fill='#888'>${6-i}</text>`;
      // עיגולים לאצבעות/מיתרים פתוחים/סגורים
      for(let s=0;s<6;s++){
        const fret = diagram[s];
        if(fret>0) html += `<circle cx='${10+s*8}' cy='${20+fret*10-5}' r='3' fill='#2b6cb0'/>`;
        if(fret===0) html += `<circle cx='${10+s*8}' cy='15' r='2' fill='#4e6fae'/>`;
        if(fret===-1) html += `<text x='${8+s*8}' y='18' font-size='8' fill='#b02b2b'>×</text>`;
      }
      html += `</svg>`;
      return html;
    }

    // Render songs with play button and availability badge
    async function renderSongs(){
      const el = document.getElementById('songsSection'); el.innerHTML='';
      for(const s of songsData){
        const d = document.createElement('div'); d.className='song-card';
        d.innerHTML = `<div style='display:flex;justify-content:space-between;align-items:center'><div><div class='song-title'>${s.title}</div><div class='song-artist'>${s.artist}</div></div><div style='display:flex;gap:8px;align-items:center'><button class='play-btn' data-id='${s.youtubeId}' title='נגן'>▶</button><span class='badge badge-loading' id='badge-${s.id}'><span class='spinner'></span>בודק...</span><span class='badge badge-caption' id='caption-badge-${s.id}' style='display:none'>כתוביות</span></div></div>`;
        d.addEventListener('click', (e)=>{ if(!e.target.classList.contains('play-btn')) openSongModal(s); });
        el.appendChild(d);

        // wire play button
        const playBtn = d.querySelector('.play-btn');
        playBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); playSongInline(s); });

        // check availability and show badge
        (async ()=>{
          const b = document.getElementById('badge-'+s.id);
          if(b) b.innerHTML = `<span class='spinner'></span>בודק...`;
          const ok = await checkVideoAvailable(s.youtubeId);
          if(b) {
            b.textContent = ok ? 'וידאו זמין' : 'לא זמין';
            b.className = 'badge ' + (ok ? 'badge-ok' : 'badge-error');
          }
        })();

        // check captions and show badge
        (async ()=>{
          const cb = document.getElementById('caption-badge-'+s.id);
          try{
            const r = await fetch(`/api/youtube/captions?videoId=${encodeURIComponent(s.youtubeId)}&lang=he`);
            if(r.ok){
              const j = await r.json();
              if(j && Array.isArray(j.cues) && j.cues.length>0){
                cb.style.display = '';
              }
            }
          }catch(e){}
        })();
      }
    }

    function playSongInline(song){
      createPlayer('yt-player', song.youtubeId, true);
      setChordsTimeline(song.chordsTimeline || [], 'chordsTimeline');
      setCaptionsPlaceholder('captionsBox','<span class="spinner"></span> טוען כתוביות...');
      stopCaptionsSync();
      captionsData = [];
      (async ()=>{
        try{
          const r = await fetch(`/api/youtube/captions?videoId=${encodeURIComponent(song.youtubeId)}&lang=he`);
          if(!r.ok) return setCaptionsPlaceholder('captionsBox','<span style="color:#b02b2b">כתוביות לא זמינות</span>');
          const j = await r.json();
          if(j && Array.isArray(j.cues) && j.cues.length){
            captionsData = j.cues.map(c => ({text: c.text, start: parseFloat(c.start)}));
            setCaptionsPlaceholder('captionsBox', '');
            if (ytPlayer && ytPlayer.getCurrentTime) startCaptionsSync('captionsBox', ytPlayer);
          } else setCaptionsPlaceholder('captionsBox','<span style="color:#b02b2b">כתוביות לא זמינות</span>');
        }catch(e){ setCaptionsPlaceholder('captionsBox','<span style="color:#b02b2b">כתובת השרת לא הצליחה לטעון כתוביות</span>'); }
      })();
    }

    // Modal and actions
    function openSongModal(song){
      $('#modalTitle').textContent = song.title;
      $('#modalArtist').textContent = song.artist;
      document.getElementById('songModal').classList.add('open');
      createPlayer('modalPlayer', song.youtubeId, true);
      const mt = song.chordsTimeline || [];
      document.getElementById('modalChordsTimeline').innerHTML = mt.map((c,i)=>`<div class='chord-item' id='modalChordsTimeline-chord-${i}'>${c.chord}</div>`).join('');
      setCaptionsPlaceholder('modalCaptions','<span class="spinner"></span> טוען כתוביות...');
      setChordsTimeline(song.chordsTimeline || [], 'modalChordsTimeline');
      stopCaptionsSync();
      captionsData = [];
      (async ()=>{
        try{
          const r = await fetch(`/api/youtube/captions?videoId=${encodeURIComponent(song.youtubeId)}&lang=he`);
          if(!r.ok) return setCaptionsPlaceholder('modalCaptions','<span style="color:#b02b2b">כתוביות לא זמינות</span>');
          const j = await r.json();
          if(j && Array.isArray(j.cues) && j.cues.length){
            captionsData = j.cues.map(c => ({text: c.text, start: parseFloat(c.start)}));
            setCaptionsPlaceholder('modalCaptions', '');
            if (window.ytPlayer && ytPlayer.getCurrentTime) startCaptionsSync('modalCaptions', ytPlayer);
          } else setCaptionsPlaceholder('modalCaptions','<span style="color:#b02b2b">כתוביות לא זמינות</span>');
        }catch(e){ setCaptionsPlaceholder('modalCaptions','<span style="color:#b02b2b">שגיאת שרת בטעינת כתוביות</span>'); }
      })();
    }

    document.getElementById('modalClose').addEventListener('click', ()=>{
      document.getElementById('songModal').classList.remove('open');
      try{ if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo(); }catch(e){}
      stopCaptionsSync();
    });

    // Tab handling and search
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click', e=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      e.target.classList.add('active');
      const tab = e.target.getAttribute('data-tab');
      if(tab==='chords'){ document.getElementById('chordsSection').style.display='grid'; document.getElementById('songsSection').style.display='none'; }
      else { document.getElementById('chordsSection').style.display='none'; document.getElementById('songsSection').style.display='grid'; }
    }));

    // חיפוש וסינון אקורדים
    document.getElementById('searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.trim();
      const cat = document.getElementById('chordCategoryFilter').value;
      renderChords(q, cat);
    });
    document.getElementById('chordCategoryFilter').addEventListener('change', (e)=>{
      const q = document.getElementById('searchInput').value.trim();
      renderChords(q, e.target.value);
    });

    document.getElementById('searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){ renderSongs(); return; }
      const filtered = songsData.filter(s=> (s.title + ' ' + s.artist).toLowerCase().includes(q) );
      const el = document.getElementById('songsSection'); el.innerHTML='';
      filtered.forEach(s=>{ const d=document.createElement('div'); d.className='song-card'; d.innerHTML = `<div class='song-title'>${s.title}</div><div class='song-artist'>${s.artist}</div>`; d.addEventListener('click',()=>openSongModal(s)); el.appendChild(d); });
    });

    document.getElementById('chordCategoryFilter').addEventListener('change', (e)=>{
      const cat = e.target.value;
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      renderChords(query, cat);
    });

    // Initial render
    renderChords();
    renderSongs();
    // בעת טעינת שיר, הצג timeline בסגנון chordify
    function showSongDetails(song){
      setChordsTimeline(song.chordsTimeline, 'chordsTimeline', song.strumming);
    }
  </script>
</body>
</html>
