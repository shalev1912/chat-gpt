<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>סודוקו מתקדם</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Heebo&display=swap');
  body {
    font-family: 'Heebo', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin-top: 20px;
    margin-bottom: 5px;
  }
  #game {
    margin: 20px auto;
    background: rgba(0,0,0,0.25);
    border-radius: 15px;
    padding: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }
  table {
    border-collapse: collapse;
    margin: 10px auto;
  }
  td {
    width: 50px; height: 50px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #555;
    font-size: 24px;
    font-weight: 700;
    cursor: pointer;
    position: relative;
    background: rgba(255,255,255,0.05);
    user-select: none;
  }
  td.preset {
    color: #aaddff;
    font-weight: 900;
    cursor: default;
    background: rgba(0,0,0,0.3);
  }
  td.invalid {
    background: #ff4d4d;
    animation: blink 0.5s ease 2;
  }
  td.selected {
    background: rgba(255,255,255,0.2);
  }
  /* עיצוב בלוקים 3x3 */
  td.block-right {
    border-right: 3px solid #888;
  }
  td.block-bottom {
    border-bottom: 3px solid #888;
  }
  /* pencil marks */
  .pencil-marks {
    font-size: 10px;
    color: rgba(255,255,255,0.6);
    position: absolute;
    top: 2px; left: 2px;
    width: 46px; height: 46px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    pointer-events: none;
  }
  .pencil-marks span {
    text-align: center;
    line-height: 14px;
  }
  /* controls */
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  button {
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #4a4a8a;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    transition: background 0.3s ease;
  }
  button:hover {
    background: #7a7add;
  }
  #message {
    margin-top: 10px;
    height: 22px;
    text-align: center;
    font-weight: 700;
    color: #ff5555;
    min-height: 24px;
  }
  #timer {
    margin-top: 10px;
    font-size: 16px;
    font-weight: 700;
    color: #ccc;
    user-select: none;
  }
  #difficulty {
    margin: 10px auto 0 auto;
    text-align: center;
  }
  #difficulty select {
    padding: 6px 10px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #555;
    color: white;
    cursor: pointer;
  }
  #homeLink {
    margin-top: 20px;
    color: #aaddff;
    text-decoration: underline;
    cursor: pointer;
    font-size: 16px;
    user-select: none;
  }
  #homeLink:hover {
    color: #fff;
  }
  /* Animations */
  @keyframes blink {
    0%, 100% { background-color: #ff4d4d; }
    50% { background-color: rgba(255,77,77,0.6); }
  }
</style>
</head>
<body>
<h1>סודוקו מתקדם</h1>

<div id="difficulty">
  רמת קושי:
  <select id="difficultySelect">
    <option value="easy" selected>קל</option>
    <option value="medium">בינוני</option>
    <option value="hard">קשה</option>
  </select>
  <button id="newGameBtn">התחל משחק חדש</button>
</div>

<div id="game" aria-label="לוח סודוקו" role="application" tabindex="0">
  <!-- הלוח יווצר פה דינמית -->
</div>

<div id="controls" aria-label="שליטה במשחק">
  <button id="undoBtn" title="בטל צעד אחרון">Undo ↩</button>
  <button id="redoBtn" title="חזור על צעד שבוטל">Redo ↪</button>
  <button id="clearPencilBtn" title="נקה סימוני אפשרויות">נקה סימוני עיפרון</button>
  <button id="solveBtn" title="פתור את הפאזל אוטומטית">פתור אוטומטית</button>
</div>

<div id="message" aria-live="polite" role="alert"></div>
<div id="timer" aria-label="שעון עצר">זמן: 00:00</div>

<div id="homeLink" tabindex="0" role="link" aria-label="חזור למסך הבית">← חזרה למסך הבית</div>

<script>
(() => {
  // סט פונקציות וסטרקטורות בסיסיות עבור סודוקו מתקדם

  // יצירת לוח 9x9 ריק
  const SIZE = 9;
  const BLOCK = 3;

  const gameDiv = document.getElementById('game');
  const messageEl = document.getElementById('message');
  const timerEl = document.getElementById('timer');
  const difficultySelect = document.getElementById('difficultySelect');
  const newGameBtn = document.getElementById('newGameBtn');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const clearPencilBtn = document.getElementById('clearPencilBtn');
  const solveBtn = document.getElementById('solveBtn');
  const homeLink = document.getElementById('homeLink');

  // מצב המשחק - מחזיק את הלוח הנוכחי, סימוני העיפרון והיסטוריית צעדים
  let board = [];
  let initialBoard = [];
  let pencilMarks = []; // מערך דו-ממדי עם מערכי אפשרויות בכל תא
  let selectedCell = null; // [row,col]
  let history = [];
  let redoStack = [];
  let timerInterval = null;
  let startTime = null;

  // פונקציה ליצירת לוח HTML דינמי עם תאים
  function createBoard() {
    gameDiv.innerHTML = '';
    const table = document.createElement('table');
    table.setAttribute('aria-label', 'לוח סודוקו');
    for(let r=0; r<SIZE; r++) {
      const tr = document.createElement('tr');
      for(let c=0; c<SIZE; c++) {
        const td = document.createElement('td');
        td.dataset.row = r;
        td.dataset.col = c;

        // גבולות בלוקים עבים
        if ((c+1) % BLOCK === 0 && c !== SIZE - 1) td.classList.add('block-right');
        if ((r+1) % BLOCK === 0 && r !== SIZE - 1) td.classList.add('block-bottom');

        // למנוע סימון טקסט
        td.style.userSelect = "none";

        // הוסף אלמנט pencil marks קטן בתוך התא
        const pencilDiv = document.createElement('div');
        pencilDiv.className = 'pencil-marks';
        td.appendChild(pencilDiv);

        // מאזין ללחיצה על תא
        td.addEventListener('click', () => selectCell(r,c));
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    gameDiv.appendChild(table);
  }

  // בחירת תא, סימון כבחור נוכחי
  function selectCell(row,col) {
    clearMessage();
    if(selectedCell){
      const [sr, sc] = selectedCell;
      const prevCell = getCellElement(sr, sc);
      prevCell.classList.remove('selected');
    }
    selectedCell = [row,col];
    const cell = getCellElement(row,col);
    cell.classList.add('selected');
  }

  // מחזיר את תא ה-td לפי שורה ועמודה
  function getCellElement(row,col){
    return gameDiv.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
  }

  // הצגת הלוח לפי המערכים board ו-pencilMarks
  function renderBoard() {
    for(let r=0; r<SIZE; r++){
      for(let c=0; c<SIZE; c++){
        const cell = getCellElement(r,c);
        cell.textContent = '';
        cell.classList.remove('preset', 'invalid');
        // אם יש מספר בהתחלה - סימן כאילו preset ולא ניתן לשינוי
        if(initialBoard[r][c] !== 0){
          cell.textContent = initialBoard[r][c];
          cell.classList.add('preset');
        } else {
          if(board[r][c] !== 0) {
            cell.textContent = board[r][c];
          }
        }
        // הצגת סימוני עיפרון
        const pencilDiv = cell.querySelector('.pencil-marks');
        pencilDiv.innerHTML = '';
        if(pencilMarks[r][c].size > 0 && board[r][c] === 0) {
          for(let n=1; n<=9; n++){
            const span = document.createElement('span');
            if(pencilMarks[r][c].has(n)) {
              span.textContent = n;
            } else {
              span.textContent = '';
            }
            pencilDiv.appendChild(span);
          }
        }
      }
    }
  }

  // בדיקה אם הכנסת מספר חוקית (שורה, עמודה ובלוק)
  function isValidMove(row, col, num, currentBoard = board) {
    if(num < 1 || num > 9) return false;

    // שורה
    for(let c=0; c<SIZE; c++){
      if(c !== col && currentBoard[row][c] === num) return false;
    }
    // עמודה
    for(let r=0; r<SIZE; r++){
      if(r !== row && currentBoard[r][col] === num) return false;
    }
    // בלוק 3x3
    const br = Math.floor(row / BLOCK)*BLOCK;
    const bc = Math.floor(col / BLOCK)*BLOCK;
    for(let rr=br; rr<br+BLOCK; rr++){
      for(let cc=bc; cc<bc+BLOCK; cc++){
        if((rr !== row || cc !== col) && currentBoard[rr][cc] === num) return false;
      }
    }
    return true;
  }

  // בדיקת אם הלוח מלא ותקין (האם המשחק הושלם)
  function isBoardComplete() {
    for(let r=0; r<SIZE; r++){
      for(let c=0; c<SIZE; c++){
        if(board[r][c] === 0 || !isValidMove(r,c,board[r][c])) return false;
      }
    }
    return true;
  }

  // הכנסת מספר לתא נבחר
  function inputNumber(num, pencil=false) {
    if(!selectedCell){
      showMessage('בחר תא לפני הכנסת מספר');
      return;
    }
    const [r,c] = selectedCell;
    if(initialBoard[r][c] !== 0){
      showMessage('לא ניתן לשנות את המספר הראשוני');
      return;
    }
    if(pencil){
      // עדכון סימוני עיפרון - הוספה או הסרה
      if(pencilMarks[r][c].has(num)){
        pencilMarks[r][c].delete(num);
      } else {
        pencilMarks[r][c].add(num);
      }
      saveHistory();
      renderBoard();
      return;
    }
    // הכנסת מספר רגילה
    if(num === 0) {
      // מחיקת מספר
      board[r][c] = 0;
      pencilMarks[r][c].clear();
      saveHistory();
      renderBoard();
      return;
    }
    if(!isValidMove(r,c,num)){